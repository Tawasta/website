<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- Add link to navigation bar when user has unread messages -->
    <template id="header" inherit_id="website.layout" name="Unread Messages Link">
        <xpath expr="//header//ul[@id='top_menu']/li" position="before">
            <t t-set="partner" t-value="request.env.user.partner_id"/>
            <t t-if="request.env.ref('base.public_partner').id != partner.id">
                <t t-set="unread_messages_count" t-value="partner.sudo(request.env.user).get_portal_needaction_count()" />
                <t t-set="is_enabled" t-value="request.env['ir.config_parameter'].sudo().get_param('website_unread_messages.icp_unread_messages_page')"/>
                <li t-att-class="'nav-item' if is_enabled == '1' else 'd-none'">
                    <a class="nav-link" href="/unread_messages">
                        <span>Messages <sup class="messages_quantity badge badge-primary" t-esc="unread_messages_count or '0'" /></span>
                        <span class="sr-only">Unread messages</span>
                    </a>
                </li>
            </t>
        </xpath>
    </template>

    <!-- Page for showing the unread messages and links to the pages -->
    <template id="unread_messages" name="Unread messages">
        <t t-call="website.layout">
            <t t-set="title">Unread messages</t>
            <div id="wrap">
                <div class="oe_structure"/>
                <div class="container">
                    <h1 t-if="messages" class="mt32">
                        Unread messages
                    </h1>
                    <t t-if="pager">
                        <t t-call="portal.pager">
                            <t t-set="classname">pull-right mb-3</t>
                        </t>
                    </t>
                    <!-- Create a list of unread messages that have a link to page where the message can be read -->
                    <div class="mt32">
                        <table t-if="messages" class="table table-hover">
                            <thead>
                                <tr class="active">
                                    <th>Where</th>
                                    <th>By whom</th>
                                    <th>When</th>
                                </tr>
                            </thead>
                            <t t-foreach="messages" t-as="message">
                                <tr>
                                    <td>
                                        <a title="URL where the message is" t-att-href="message.website_url">
                                            <t t-esc="message.record_name"/>
                                        </a>
                                    </td>
                                    <td><span title="Author of the message" t-field="message.sudo().author_id.name"/></td>
                                    <td>
                                        <span t-field="message.create_date" t-field-options='{"format": "dd.MM.yyyy HH:mm"}' />
                                    </td>
                                </tr>
                            </t>
                        </table>
                    </div>
                    <t t-if="pager">
                        <t t-call="portal.pager">
                            <t t-set="classname">pull-right</t>
                        </t>
                    </t>
                    <t t-if="not messages">
                        <div class="mt64">
                            <h2 class="text-center">You don't have any unread messages!<br/>Well done!</h2>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>
</odoo>
