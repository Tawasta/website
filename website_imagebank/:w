from odoo import http, _, tools
import base64
from PIL import Image, ExifTags
from io import BytesIO

class VisitorImgUpload(http.Controller):

    def fix_img_orientation(self, img):
        img = Image.open(BytesIO(img))
        orientation = img._getexif()[274]
        if orientation == 3:
            img.rotate(180, expand=True)
        elif orientation == 6:
            img.rotate(270, expand=True)
        elif orientation == 8:
            img.rotate(90, expand=True)
        return img


    def optimize_img(self, img):
        img = Image.open(BytesIO(img))
        img_optimized = tools.image_save_for_web(img)
        return img_optimized

    @http.route('/imagebank', auth='public', type='http', website=True)
    def visitor_gallery(self, **kw):
        categories = http.request.env['imagebank.image'].get_category_list()
        image_urls = http.request.env['imagebank.image'].get_published_urls()
        image_urls_by_category = \
            http.request.env['imagebank.image'].get_image_urls_by_category()
        return http.request.render('website_imagebank.imagebank_gallery', {
            'categories': categories,
            'image_urls': image_urls,
            'image_urls_by_category': image_urls_by_category,
        })

    @http.route(['/imagebank/add_image'], type='http', auth='public', methods=['POST'], website=True)
    def create_slide(self, *args, **post):
        if post.get('image'):
            try:
                for img_filestorage in http.request.httprequest.files.getlist('image'):

                    Attachment = http.request.env['ir.attachment'].sudo()
                    VisitorImage = http.request.env['imagebank.image'].sudo()

                    img = img_filestorage.read()
                    img = self.fix_img_orientation(img)
                    img_optimized = self.optimize_img(img)
                    datas = base64.b64encode(img_optimized)
                    filename = img_filestorage.filename
                    category = http.request.env['imagebank.category'].search(
                        [('name', '=', post.get('category'))])

                    attachment = Attachment.create({
                        'name': filename,
                        'datas': datas,
                        'type': 'binary',
                        'datas_fname': filename,
                        'public': True,
                    })

                    VisitorImage.create({
                        'name': filename,
                        'filename': filename,
                        'attachment': attachment.id,
                        'image_url': "/web/image/" + str(attachment.id) + "/" + filename,
                        'category': category.id,
                    })

                return http.request.render('website_imagebank.imagebank_gallery_thank_you', {})
            except Exception as e:
                print(e)
                return http.request.render('website_imagebank.imagebank_gallery_error', {
                    'message': ""
                })

        else:
            return http.request.render('website_imagebank.imagebank_gallery_error', {
                'message': _('Image file missign.')
            })



